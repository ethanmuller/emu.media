<!doctype html>
<html class="no-js" lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>forms</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="/apple-touch-icon.png">
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">

        <style>
         * {
             box-sizing: border-box;
         }

         body {
             background: black;
             color: white;
             font-family: 'IBM Plex Mono', monospace;
             text-transform: lowercase;
         }

         h1 {
             font-size: 1rem;
             font-weight: normal;
             margin-bottom: 3rem;
         }

         button {
             border: none;
         }

         meter {
             margin-top: 1.5rem;
         }

         [hidden] {
             display: none !important;
         }

         .btn {
         }

         .btn--primary {
             font: inherit;
             font-weight: bold;
             padding: 1rem 3rem;
             color: white;
             background: #0066FF;
         }

         .btn--secondary {
             padding: 0.5rem 1rem;
             color: #f1f1f1;
             background: #333;
         }

         #app {
             display: flex;
             flex-direction: column;
             justify-content: center;
             align-items: center;
             min-height: 100vh;
         }

         .app-layout {
             display: flex;
             align-items: center;
         }
         .app-layout > :nth-child(1) {
             order: 1;
         }
         .app-layout > :nth-child(2) {
             order: 3;
         }
         .app-layout > :nth-child(3) {
             order: 2;
         }

         .title-layout {
             width: 420px;
         }

         .card {
             /* background: white;
                border-radius: 13px;
                padding: 2.3rem 1.75rem 1.75rem; */
             min-height: 420px;
             width: 100%;
             max-height: 100vh;
             display: flex;
             flex-direction: column;
             justify-content: center;

             font-size: 1.125rem;
         }

         .card.show {
             animation: reveal 1s linear both;
         }

         @keyframes reveal {
             from {
                 opacity: 0;
             }
             to {
                 opacity: 1;
             }

         }

         @keyframes unblur {
             from {
                 filter: blur(15px) saturate(0.6) contrast(1.5);
             }
             to {
                 filter: blur(0px) saturate(1) contrast(1);
             }

         }

         .card img {
             max-width: 100%;
             max-height: 600px;

             /* the animation keyframes should override this
                this is meant to prevent flash of unblurred image? */
             filter: blur(18px);
         }

         .card img.blur {
             animation: unblur var(--blur-time) cubic-bezier(.38,.76,.97,.28) both;
             animation-delay: 10s;
         }

         .lil-btn {
             background-color: #333;
             color: white;
             border-radius: 99rem;
             padding: 1rem;
         }

         .lil-btn--prev {
             margin-right: 1rem;

             /* put in corner */
             position: fixed;
             bottom: 1rem;
             left: 1rem;
         }

         .lil-btn--prev svg {
             transform: scaleX(-1);
         }

         .lil-btn--next {
             margin-left: 1rem;

             /* put in corner */
             position: fixed;
             bottom: 1rem;
             right: 1rem;
         }

         .meta {
             font-size: 14px;
             color: #A5A5A5;
             text-align: center;
             padding-top: 0.5rem;
         }

         .time-slider {
             position: relative;

             margin: 3rem 0 0;
         }
         .time-slider__time {
             position: absolute;
             top: 0;
             right: 0;
             text-align: right;
             font-size: 14px;
         }
         .split {
             display: flex;
             width: 100%;
             justify-content: space-between;

             margin-bottom: 3rem;
         }
         .split span {
             display: block;
             font-size: 14px;
         }
         label span {
             display: block;
             font-size: 14px;
         }
         [type=range] {
             width: 100%;
         }

         .sp-t {
             margin-top: 1.5rem;
         }

         .sp-b {
             margin-bottom: 1.5rem;
         }

         .ta-c {
             text-align: center;
         }
         small {
             opacity: 0.3;
         }
        </style>

    </head>
    <body>
        <div id="app">
            <div class="title-layout">
                <h1 v-if="!isStarted">forms</h1>
                <div v-if="!isLoaded" class="meta">loading...</div>
                <div v-if="!isStarted && isLoaded">
                    <p>you will be shown a series of images</p>
                    <p>please draw what you see</p>
                    <p>if the image is unclear, look deeper</p>
                    <!-- <p class="sp-t">this process will take about 10 minutes</p> -->
                    <p class="sp-t sp-b">There are <strong>{{cards.length}} cards</strong> in the deck</p>
                    <div class="time-slider">
                        <label>
                            <span>First Card</span>
                            <input type="range" min="0" v-bind:max="cards.length - 1" step="1" v-model="startIndex">
                        </label>
                        <div class="time-slider__time">{{parseInt(startIndex, 10) + 1}}</div>
                    </div>
                    <div class="time-slider">
                        <label>
                            <span>Last Card:</span>
                            <input type="range" min="1" v-bind:max="cards.length" step="1" v-model="endIndex">
                        </label>
                        <div class="time-slider__time">{{ parseInt(endIndex, 10) + 1 }}</div>
                    </div>

                    <div class="time-slider">
                        <label>
                            <span>Time Per Card:</span>
                            <input type="range" min="30" max="180" step="10" v-model="secondsPerCard">
                        </label>
                        <div class="time-slider__time">{{formatTime(secondsPerCard)}}</div>
                    </div>
                    <div class="split">
                        <span>Total Time:</span>
                        <span>{{formatTime(secondsPerCard * (endIndex - startIndex))}}</span>
                    </div>
                    <button class="sp-t btn btn--primary" v-on:click="start">start</button>
                </div>
            </div>
            <div class="app-layout" v-if="isStarted && !isDone">
                <button class="lil-btn lil-btn--prev" v-on:click="previous"><svg width="21" height="12" viewBox="0 0 21 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.8387 0L21 6L10.8387 12V7.03923H0V4.96077H10.8387V0Z" fill="black"/></svg></button>
                <button class="lil-btn lil-btn--next" v-on:click="next"><svg width="21" height="12" viewBox="0 0 21 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.8387 0L21 6L10.8387 12V7.03923H0V4.96077H10.8387V0Z" fill="black"/></svg></button>
                <div>
                    <div v-bind:class="{ show: isBlurred, card: true }">
                        <div><img v-bind:src="hand[index].image.display.url" v-bind:class="{ blur: isBlurred }"></div>
                        <meter class="progress" v-bind:value="secondsRemaining" min="0" v-bind:max="secondsPerCard" v-bind:low="secondsPerCard * 0.333"></meter>
                    </div>
                    <div class="meta">{{formatTime(secondsRemaining)}}</div>
                    <div class="meta">{{ index + 1 }} of {{ hand.length }}</div>
                </div>
            </div>
            <div v-if="isDone" class="ta-c">
                <div>All done âœ¨</div>
                <button class="btn btn--secondary sp-t" v-on:click="reset">Reset</button>
            </div>
        </div>

        <script>
         function formatTime(seconds) {
             const m = Math.floor(seconds/60)
             const s = seconds % 60
             return `${m}:${s.toString().padStart(2,'0')}`
         }

         const app = new Vue({
             el: '#app',
             data() {
                 return {
                     secondsPerCard: 120,
                     isLoaded: false,
                     isStarted: false,
                     isDone: false,
                     index: 0,
                     cards: [],
                     endIndex: 0,
                     hand: [],
                     counterID: null,
                     startIndex: 0,
                     secondsRemaining: null,
                     isBlurred: true,
                 }
             },
             mounted () {
                 this.fetchItems()
                 this.setCssVariables()
             },
             watch: {
                 secondsPerCard() {
                     this.setCssVariables()
                 },
                 cards() {
                   this.endIndex = this.cards.length
                 },
                 startIndex() {
                     this.endIndex = Math.max(this.startIndex, this.endIndex)
                 },
                 endIndex() {
                     this.endIndex = Math.max(this.startIndex, this.endIndex)
                 },
             },
             computed: {
                 allCards() {
                     return this.cards.length - this.startIndex <= parseInt(this.endIndex, 10)
                 },
             },
             methods: {
                 setCssVariables() {
                     const blurTime = this.secondsPerCard - 10;
                     let root = document.documentElement;
                     root.style.setProperty('--blur-time', `${blurTime}s`);
                 },
                 stopTicking() {
                   window.clearInterval(this.counterID)
                 },
                 start() {
                     this.hand = this.cards.slice(this.startIndex, this.endIndex)
                     this.isStarted = true
                     this.startTicking()
                     this.secondsRemaining = this.secondsPerCard
                 },
                 startTicking() {
                     this.counterID = window.setInterval(() => {
                         this.tick()
                     }, 1000)
                 },
                 tick() {
                     this.secondsRemaining -= 1
                     if (this.secondsRemaining < 0) {
                         this.secondsRemaining = this.secondsPerCard
                         this.next()
                     }
                 },
                 reset() {
                     this.stopTicking()
                     this.isStarted = false
                     this.isDone = false
                     this.index = 0
                 },
                 done() {
                     this.isDone = true
                     this.stopTicking()
                 },
                 next() {
                     if (this.index < this.hand.length - 1) {
                         this.index += 1
                         this.secondsRemaining = this.secondsPerCard

                         this.isBlurred = false
                         setTimeout(() => {
                             this.isBlurred = true
                         }, 1)

                     } else {
                         this.done()
                     }
                 },
                 previous() {
                     if (this.index > 0) {
                         this.index -= 1
                         this.secondsRemaining = this.secondsPerCard
                     } else {
                         this.reset()
                     }
                 },
                 fetchItems() {
                     fetch('https://api.are.na/v2/channels/drawling-8nige30zeku/contents?per=50')
                         .then(response => response.json())
                         .then(data => this.cards = data.contents)
                         .then(() => this.isLoaded = true)
                         .catch(error => console.error(error))
                 }
             }
         })
        </script>

    </body>
</html>
